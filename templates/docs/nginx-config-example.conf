# Nginx 配置示例 - Claude Workflow Toolkit
# 用于托管安装脚本和工具包压缩包

# ============================================
# 方式 1：使用 alias 指令（推荐）
# ============================================

server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名

    # 安装脚本路径
    # 访问 URL: http://your-domain.com/install.sh
    location = /install.sh {
        alias /home/sudo_root/workflow/online-install.sh;

        # 设置正确的 Content-Type
        default_type text/x-shellscript;
        add_header Content-Type "text/x-shellscript; charset=utf-8";

        # 允许跨域访问（可选）
        add_header Access-Control-Allow-Origin "*";

        # 禁用缓存，确保用户获取最新版本
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Releases 目录（压缩包和校验和）
    # 访问 URL: http://your-domain.com/releases/claude-workflow-toolkit-v1.0.0.tar.gz
    location /releases/ {
        alias /home/sudo_root/workflow/;

        # 允许列出目录（可选，方便查看所有版本）
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        # 允许跨域访问（可选）
        add_header Access-Control-Allow-Origin "*";

        # 缓存配置（压缩包可以缓存）
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # 安全配置
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
}

# ============================================
# 方式 2：使用 root 指令
# ============================================

server {
    listen 80;
    server_name your-domain.com;

    root /home/sudo_root/workflow;

    # 安装脚本
    location = /install.sh {
        try_files /online-install.sh =404;
        default_type text/x-shellscript;
        add_header Content-Type "text/x-shellscript; charset=utf-8";
        add_header Cache-Control "no-cache";
    }

    # 压缩包和校验和文件
    location ~ \.(tar\.gz|sha256)$ {
        add_header Content-Type "application/octet-stream";
        add_header Cache-Control "public, max-age=3600";
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
}

# ============================================
# 方式 3：HTTPS 配置（生产环境推荐）
# ============================================

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS 服务器
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置（使用 Let's Encrypt）
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 安装脚本
    location = /install.sh {
        alias /home/sudo_root/workflow/online-install.sh;
        default_type text/x-shellscript;
        add_header Content-Type "text/x-shellscript; charset=utf-8";
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Releases 目录
    location /releases/ {
        alias /home/sudo_root/workflow/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        expires 1h;
    }

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# ============================================
# 方式 4：完整配置（带访问日志和限流）
# ============================================

# 定义限流区域（防止恶意下载）
limit_req_zone $binary_remote_addr zone=download_limit:10m rate=10r/m;

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # 访问日志（记录安装统计）
    access_log /var/log/nginx/claude-toolkit-access.log combined;
    error_log /var/log/nginx/claude-toolkit-error.log warn;

    # 安装脚本
    location = /install.sh {
        alias /home/sudo_root/workflow/online-install.sh;
        default_type text/x-shellscript;
        add_header Content-Type "text/x-shellscript; charset=utf-8";
        add_header Cache-Control "no-cache";

        # 记录安装脚本下载
        access_log /var/log/nginx/install-script-downloads.log combined;
    }

    # Releases 目录（应用限流）
    location /releases/ {
        alias /home/sudo_root/workflow/;

        # 限流：每分钟最多 10 次请求
        limit_req zone=download_limit burst=5 nodelay;

        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        # 记录压缩包下载
        access_log /var/log/nginx/package-downloads.log combined;
    }

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
}
