---
description: Diff 审查 - 基于 git diff 的通用代码审查
allowed-tools: Read(*), Grep(*), Glob(*), Bash(git *)
examples:
  - /diff-review
    审查未提交的代码变更
  - /diff-review --staged
    审查已暂存的变更
  - /diff-review --branch main
    审查当前分支相对 main 的所有变更
---

# Diff 代码审查

基于 git diff 的通用代码审查，支持多种变更来源。

## 输入格式

根据用户指定的来源获取 diff：

| 参数 | 来源 | git 命令 |
|------|------|----------|
| (默认) | 未暂存变更 | `git diff` |
| `--staged` | 已暂存变更 | `git diff --cached` |
| `--all` | 全部未提交 | `git diff HEAD` |
| `--branch <base>` | 对比分支 | `git diff <base>...HEAD` |

## 审查指南

判断是否应该标记为问题的原则：

1. 显著影响代码的准确性、性能、安全性或可维护性
2. 问题是具体且可操作的（非泛泛的代码库问题）
3. 修复不需要超出代码库现有标准的严格程度
4. 问题是在本次变更中引入的（不是预先存在的）
5. 原作者如果知道会愿意修复
6. 不依赖于未说明的假设
7. 如果认为变更可能破坏其他部分，必须找到具体受影响的代码
8. 不是原作者的故意设计

**忽略的问题**：
- 琐碎的风格问题（除非影响可读性或违反文档标准）
- 非阻塞问题（风格、格式、拼写、文档）

## 优先级定义

| 级别 | 含义 | 标准 |
|------|------|------|
| P0 | 紧急阻塞 | 阻塞发布/运营，不依赖任何输入假设的普遍问题 |
| P1 | 紧急 | 应在下个周期处理 |
| P2 | 正常 | 最终需要修复 |
| P3 | 低优先级 | 有则更好 |

## 评论规范

1. 清楚说明为什么是问题
2. 准确传达问题严重性，不夸大
3. 简洁（正文最多 1 段，除非代码片段需要换行）
4. 代码片段不超过 3 行，使用 markdown 代码标记
5. 明确说明触发问题的场景、环境或输入
6. 语气客观，不带指责或过度积极
7. 让原作者无需仔细阅读即可理解
8. 避免过度赞美（如"做得好"、"感谢"）

## 执行流程

1. 根据用户参数获取 diff 内容
2. 分析所有变更文件
3. 识别符合标记标准的问题
4. 生成结构化审查报告

## 输出格式

```
# Review Report

## Summary
| Field | Value |
|-------|-------|
| Verdict | ✅ CORRECT / ❌ INCORRECT |
| Confidence | 0.XX |

**Explanation**: <1-3 句解释 verdict 的理由>

---

## Findings

> 如无发现，输出：**No findings.**

### [PX] <标题（≤80字符，祈使句）>

| Field | Value |
|-------|-------|
| File | `<绝对文件路径>` |
| Lines | <start>-<end> |
| Confidence | 0.XX |

<正文：1 段说明为什么是问题>

```suggestion
<可选：具体替换代码，保持原有缩进>
```

---

（每个发现用 `---` 分隔）
```

## 格式规则

1. **Summary 表格**：Verdict 使用 emoji 前缀（✅/❌），Confidence 为 0.00-1.00 的浮点数
2. **Finding 标题**：格式为 `### [PX] 标题`，X 为 0-3
3. **Finding 表格**：File 用反引号包裹，Lines 为 `start-end` 整数
4. **Suggestion 块**：仅在提供具体修复代码时包含，保持原有空白字符
5. **分隔符**：Finding 之间和 Summary 之后使用 `---`
6. **无额外内容**：不添加模板之外的前言或结语
7. **行范围**：尽可能短（≤5-10 行），必须与 diff 重叠

**工作目录**：当前项目目录（自动识别 `process.cwd()`）
