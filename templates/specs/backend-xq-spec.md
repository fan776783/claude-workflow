# 后端需求分析规范

本规范定义后端需求分析文档（xq.md）的结构、内容要求和质量标准。

---

## 文档定位

xq.md 是从产品需求（PRD）到技术方案（fasj.md）的桥梁：
- **输入**：产品需求文档（PRD）
- **输出**：面向后端的、可执行的需求分析
- **不做**：详细技术方案（留给 fasj.md）

---

## 文档结构要求

### 0. 元信息（必填）

```markdown
## 0. 元信息
- 源 PRD：{PRD 文档路径}
- 文档版本：v1.0
- 生成时间：{ISO 时间}
- 参与 Agent：Claude Code（分析）、Codex（审查）
- 相关设计文档：{fasj.md 路径，生成后补充}
```

### 1. 背景与业务目标（必填）

**内容要求**：
- 业务背景简述（1-2 段）
- 目标用户/系统
- 本次迭代的核心业务目标（3-5 点）

**示例**：
```markdown
## 1. 背景与业务目标

### 业务背景
用户管理系统是平台的核心模块，当前系统存在权限粒度过粗、
无法支持多租户等问题，需要进行重构。

### 核心目标
1. 支持多租户隔离
2. 实现细粒度 RBAC 权限控制
3. 提供完整的审计日志
```

### 2. 范围与边界（必填）

#### 2.1 In Scope（本次迭代范围）
- 明确列出本次迭代要做的功能
- 使用"能做什么"的描述方式

#### 2.2 Out of Scope（明确不做）
- 明确排除的功能
- 可选：未来版本候选项

**重要性**：边界清晰是避免范围蔓延的关键。

### 3. 角色与主体（必填）

**内容要求**：
- 业务角色（用户类型、权限级别）
- 系统角色（服务、批处理任务）
- 上下游系统（直接交互的其他系统）
- 各角色的关键能力与约束

### 4. 关键业务流程与用例（必填）

#### 4.1 典型场景（Use Cases）

```markdown
### UC-01：{用例名称}

**触发条件**：{什么情况下触发}

**前置条件**：{执行前必须满足的条件}

**主成功路径**：
1. 用户发起请求
2. 系统验证权限
3. 系统执行操作
4. 系统返回结果

**备用/异常路径**：
- 2a. 权限不足：返回 403 错误
- 3a. 数据不存在：返回 404 错误
```

#### 4.2 状态流转（如有）
- 实体的状态机
- 状态列表、迁移条件

### 5. 功能需求拆解（必填）

**这是后端开发的"需求 backlog"**

```markdown
### FR-01：{功能名称}

- **来源**：{PRD 章节/用例}
- **描述**：{一句话 + 细化说明}
- **触发方式**：API / 定时任务 / 事件 / 管理端操作
- **依赖**：{其他 FR / 现有服务}
- **优先级**：P0 / P1 / P2
```

**命名规范**：FR-01, FR-02, FR-03...

### 6. 非功能需求（必填）

**内容要求**：
- **性能**：QPS、峰值、延迟、数据量级
- **可用性**：SLA 目标、降级策略需求
- **安全**：鉴权模型、敏感数据、审计需求
- **合规**：日志留存、隐私相关约束
- **可观测性**：关键埋点、指标、日志需求
- **运维**：配置、开关、灰度发布需求

### 7. 数据与接口线索（必填）

**内容要求**：
- 核心业务实体草稿（不到表结构，只描述是什么）
- 必要的查询维度
- 外部系统交互点（调用谁做什么）

**注意**：这里只是"线索"，详细设计在 fasj.md 中。

### 8. 风险、依赖与假设（必填）

**内容要求**：

| 风险 | 影响 | 缓解思路 |
|------|------|----------|
| ... | ... | ... |

- 外部依赖：其他服务/团队/三方系统
- 关键假设（需要后续验证）

### 9. 验收标准（必填）

**内容要求**：
- 验收场景清单（可映射到 E2E 测试）
- 后端验收信号（日志、指标、接口行为）

**示例**：
```markdown
### 验收场景

| 场景 | 预期结果 | 验证方式 |
|------|----------|----------|
| 正常创建用户 | 返回 201，数据入库 | API 测试 |
| 重复创建用户 | 返回 409，提示冲突 | API 测试 |
| 权限不足创建 | 返回 403 | API 测试 |
```

### 10. Codex 协作记录（必填）

```markdown
## 10. Codex 协作记录

### 提出的问题
1. {问题1}
2. {问题2}

### Codex 反馈
- {反馈1}
- {反馈2}

### 决议
- {决议1}
- {决议2}
```

---

## 质量标准

### 完整性检查清单

- [ ] 所有 PRD 功能点都有对应的 FR
- [ ] 每个 FR 都有明确的来源和依赖
- [ ] In Scope 和 Out of Scope 边界清晰
- [ ] 核心用例有完整的成功路径和异常路径
- [ ] 非功能需求有具体指标而非模糊描述
- [ ] 验收标准可测试、可验证
- [ ] 风险和假设已识别并记录

### 常见问题

| 问题 | 错误示例 | 正确示例 |
|------|----------|----------|
| 边界模糊 | "支持用户管理" | "支持用户 CRUD、角色分配、权限校验" |
| 指标缺失 | "系统要快" | "P99 延迟 < 200ms，QPS > 1000" |
| 验收不可测 | "用户体验好" | "创建用户成功率 > 99.9%" |

---

## 命名规范

- 文档路径：`.claude/docs/{baseName}-xq.md`
- baseName 从 PRD 文件名提取，去掉 `-prd` 后缀
- 示例：`user-management-prd.md` → `user-management-xq.md`

---

## 注意事项

1. **面向后端**：关注后端实现需要的信息，前端细节可省略
2. **不做技术方案**：只到"做什么"，不涉及"怎么做"
3. **可追溯性**：每个 FR 要能追溯到 PRD
4. **Codex 协作**：积极与 Codex 讨论，确保需求理解准确
5. **精简原则**：信息够用即可，不必面面俱到
