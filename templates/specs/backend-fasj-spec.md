# 后端技术方案规范

本规范定义后端技术方案文档（fasj.md）的结构、内容要求和质量标准。

---

## 文档结构要求

### 0. 元信息（必填）

```markdown
## 0. 元信息
- 源 PRD：{PRD 文档路径}
- 需求分析：{xq.md 文档路径}
- 版本：v1.0
- 方案作者：{作者}
- 审查人：Codex
- 生成时间：{ISO 时间}
- 服务/模块名称：{服务名}
```

### 1. 设计目标与原则（必填）

**内容要求**：
- 业务目标摘要（从 xq.md 精炼，3-5 点）
- 技术目标（可扩展性、可观测性、低耦合等）
- 约束条件（基础设施、技术栈限制）
- 明确不做的事情（trade-off 声明）

### 2. 架构与边界（必填）

**内容要求**：
- 服务归属的系统/领域上下文
- 与其它服务的边界划分
- 入站接口来源（谁调用本服务）
- 出站依赖（调用哪些内部/外部系统）
- 关键集成点的可靠性/幂等性要求

### 3. 模块与职责划分（必填）

**内容要求**：
- 模块列表（名称、职责、协作关系）
- 目录规划建议（如 `src/modules/user/`）
- 模块间通信方式

### 4. 数据模型设计（必填）

#### 4.1 领域模型
- 核心实体：字段、含义、约束
- 聚合边界/关系

#### 4.2 持久化模型
- 表结构草案（表名、字段、索引、主键）
- 唯一约束 & 索引设计理由
- 软删/状态字段设计

#### 4.3 缓存与派生数据（如有）
- 缓存 key 设计、TTL、淘汰策略
- 派生视图（统计表/ES 索引）

### 5. 接口设计（必填）

#### 5.1 外部 API 列表

| 名称 | Method | Path | 描述 | Auth | 幂等 |
|------|--------|------|------|------|------|
| ... | ... | ... | ... | ... | ... |

#### 5.2 请求/响应结构
- 关键接口的示例 JSON
- 字段语义说明（如状态枚举）

#### 5.3 内部接口/事件（如有）
- 事件 schema：主题、payload 结构
- 重试/补偿策略

### 6. 业务流程与状态设计（按需）

**内容要求**：
- 关键用例的后端时序
- 状态机设计（状态、迁移、触发条件）

### 7. 非功能设计（必填）

**内容要求**：
- **性能**：容量预估、QPS 估算、瓶颈与方案
- **可用性**：降级/熔断/重试策略
- **安全**：鉴权模型、权限校验点、敏感字段处理
- **可观测性**：日志结构、指标、tracing
- **运维**：配置项、开关策略、灰度/回滚

### 8. 数据迁移与兼容性（如涉及存量数据）

**内容要求**：
- 迁移策略（一次性/分批/双写）
- 回滚方案
- 兼容阶段行为

### 9. 实施计划（必填）

#### 9.1 工作项列表

```markdown
- T-01：{任务名称}
  - 依赖：{依赖项}
  - 预计耗时：{时间}
  - 描述：{详细说明}
```

#### 9.2 里程碑

- M1：数据模型落地
- M2：核心 API 可用
- M3：监控告警到位
- M4：预发布验证完成

### 10. 测试与验收方案（必填）

**内容要求**：
- 单元测试重点
- 集成测试场景（对齐 xq.md 验收标准）
- 性能/压力测试方案（如有）
- 演练/回滚验证步骤

### 11. Codex 审查记录（必填）

```markdown
## 11. Codex 审查记录

### 审查时间
{ISO 时间}

### 综合评分
{分数}/100

### 优点
- ...

### 问题与建议
- ...

### 最终结论
{是否建议开始实施}
```

---

## 质量标准

### Codex 审查评分维度

| 维度 | 权重 | 评分标准 |
|------|------|----------|
| 需求覆盖 | 20% | 是否覆盖 xq.md 中所有功能需求 |
| 架构合理性 | 20% | 模块划分、边界清晰度 |
| 数据模型 | 15% | 实体设计、索引策略 |
| 接口设计 | 15% | API 契约完整性、幂等性 |
| 非功能设计 | 15% | 性能、安全、可观测性 |
| 实施可行性 | 15% | 任务拆分合理性、依赖明确 |

### 通过标准

- **总分 ≥ 80**：可以开始实施
- **总分 60-79**：需要修改后重新审查
- **总分 < 60**：需要重新设计

---

## 命名规范

- 文档路径：`.claude/docs/{baseName}-fasj.md`
- baseName 从 PRD 文件名提取，去掉 `-prd` 后缀
- 示例：`user-management-prd.md` → `user-management-fasj.md`

---

## 注意事项

1. **与 xq.md 对齐**：fasj.md 中的功能点必须能追溯到 xq.md
2. **可执行性**：实施计划要具体到可执行的任务
3. **契约优先**：API 设计要足够详细，支持前后端并行开发
4. **风险前置**：在设计阶段识别和处理风险
5. **精简原则**：不做过度设计，只解决当前需求
